# ã¯ã˜ã‚ã«
ã€€ä»Šå›ã¯Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦Azureã«**ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨è¤‡æ•°ã‚µãƒ–ãƒãƒƒãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã®å•é¡Œã¨è§£æ±ºæ–¹æ³•**ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚
èª­è€…ã®æ–¹ãŒã€ã”è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚‚ä½“é¨“ã§ãã‚‹ã‚ˆã†ã«**ãƒãƒ³ã‚ºã‚ªãƒ³ã¨ã—ã¦æ§‹æˆ**ã—ã¦ã„ã¾ã™ã€‚


# å¯¾è±¡èª­è€…

- Azureã‚’ä½¿ç”¨ã™ã‚‹ç¾å ´ã«å¾“äº‹ã—ã¦ã„ã‚‹æ–¹
- Azureã®è³‡æ ¼å‹‰å¼·ã‚’ã—ã¦ã„ã‚‹æ–¹
- Azureã«èˆˆå‘³ãŒã‚ã‚‹æ–¹
- ã‚¯ãƒ©ã‚¦ãƒ‰ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹
- IaCã«èˆˆå‘³ãŒã‚ã‚‹æ–¹

# å…è²¬äº‹é …
- ãƒãƒ³ã‚ºã‚ªãƒ³ã«ã‚ãŸã£ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’æ”¾ç½®ã™ã‚‹ã¨æ–™é‡‘ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**ç­†è€…ãŒè¨˜äº‹ä½œæˆã®é–“ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ãŸåˆ†ã§ã¯0å††**ã§ã—ãŸã€‚è¨˜äº‹ã®æœ€å¾Œã«**ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ã®ä»•æ–¹**ã‚‚è§£èª¬ã—ã¦ãŠã‚Šã¾ã™ã®ã§ã€ãƒãƒ³ã‚ºã‚ªãƒ³ãŒçµ‚äº†ã—ãŸã‚‰**å‰Šé™¤ã‚’å®Ÿæ–½**ã—ã¦ã‚‚ã‚‰ã†ã‚ˆã†ãŠé¡˜ã„ã—ã¾ã™ã€‚
- Azureã®ç”»é¢ã«é–¢ã—ã¦ã¯ã€**2024å¹´10æœˆ02æ—¥æ™‚ç‚¹ã®ã‚‚ã®**ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã¾ã™ã€‚
- ãƒãƒ³ã‚ºã‚ªãƒ³ã«ã¯VSCodeã¨Bicepæ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ğŸ‘‰[æ‹¡å¼µæ©Ÿèƒ½ã®ä½¿ã„æ–¹](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/visual-studio-code?tabs=CLI)
- ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ã‚³ãƒ¼ãƒ‰ãŒé•·ããªã‚‹ã®ã‚’é¿ã‘ã‚‹ãŸã‚ã«ä¸€éƒ¨ã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚„NSGã®è¨˜è¿°ã‚’çœã„ã¦ä½œæˆã—ã¦ã„ã¾ã™ã€‚


# ä½¿ç”¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ»æŠ€è¡“

### Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã¯
Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã¯ã€Azureãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ãŸã‚ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ»ã‚¢ã‚ºãƒ»ã‚³ãƒ¼ãƒ‰ï¼ˆIaCï¼‰ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Bicepã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ARMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ(JSONãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)ã®è¨˜è¿°ã‚’30%ã‹ã‚‰40%å‰Šæ¸›ã§ãã‚‹ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚
ğŸ‘‰[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/overview?tabs=bicep)

### Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç‰¹å¾´
- **ç°¡æ½”ãªæ§‹æ–‡**: ç›´æ„Ÿçš„ã§ç°¡å˜ã«è¨˜è¿°ã§ãã‚‹æ§‹æ–‡ã‚’æä¾›ã—ã€ã‚ˆã‚Šå°‘ãªã„ã‚³ãƒ¼ãƒ‰ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨˜è¿°ã§ãã¾ã™ã€‚å€‹äººçš„ãªæ„Ÿè¦šçš„ã«ã¯Javascriptã¨ã‹ã«ä¼¼ã¦ã„ã¾ã™ã€‚
- **å‹ãƒã‚§ãƒƒã‚¯**: å¼·åŠ›ãªã‚³ãƒ¼ãƒ‰å†…ã®ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ©Ÿèƒ½ãŒã‚ã‚‹ã€‚VSCodeã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ãˆã°ç·¨é›†ã—ã¦ã„ã‚‹æ™‚ç‚¹ã§ã»ã¼å…¨ã¦ã®è¨˜è¿°é–“é•ã„ã‚’æŒ‡æ‘˜ã—ã¦ãã‚Œã¾ã™ã€‚
ğŸ‘‰[æ‹¡å¼µæ©Ÿèƒ½ã®ä½¿ã„æ–¹](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/visual-studio-code?tabs=CLI)
- **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–**: é–¢æ•°ã‚„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æ€§ã¨æ•´ç†ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚ä»Šå›ã®ç¾å ´ã§ã‚‚ä½•åº¦ã‚‚è¡Œã†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã«ä½œæˆã—ã¾ã—ãŸã€‚

### ARMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ(JSON)ã¨ã®æ¯”è¼ƒ
- **å¯èª­æ€§ãŒé«˜ã„**:ARMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨æ¯”è¼ƒã™ã‚‹ã¨æ˜ã‚‰ã‹ã«èª­ã¿ã‚„ã™ã„ã§ã™ã€‚äººé–“ãŒç†è§£ã—ã‚„ã™ã„æ§‹æ–‡ã‚’æ„è­˜ã—ã¦ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
- **é–‹ç™ºé€Ÿåº¦**: ç°¡æ½”ã§ã€ãƒ„ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆãŒå……å®Ÿã—ã¦ã„ã‚‹ãŸã‚ã€è¿…é€Ÿã«é–‹ç™ºãŒå¯èƒ½ã€‚ARMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã®å¯èƒ½
ğŸ‘‰[ARMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰Bicepã¸ã®å¤‰æ›](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/decompile?tabs=azure-cli)
- **ãƒ‡ãƒãƒƒã‚°ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**:ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æ–‡ã§ã‚¨ãƒ©ãƒ¼ã‚’è¦‹ã¤ã‘ã‚„ã™ã„ã€‚ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã®ç†è§£ãŒã—ã‚„ã™ã„ã®ã§ã€ãƒ‡ãƒãƒƒã‚°ãŒæ—©ã„ã§ã™ã€‚


# 1. è¦ä»¶

### è¦ä»¶â‘ ï¼šç¹°ã‚Šè¿”ã—æ‰‹å‹•ã§è¡Œã†ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ã‚µãƒ–ãƒãƒƒãƒˆãƒ»ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»NSGã®ãƒ‡ãƒ—ãƒ­ã‚¤ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã—ãŸã„ã€‚
### è¦ä»¶â‘¡ï¼šè¤‡æ•°ã‚µãƒ–ãƒãƒƒãƒˆã‚’Bicepã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€ä¾å­˜é–¢ä¿‚ã®ã‚¨ãƒ©ãƒ¼ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããªã„ã€‚
#### ã‚¨ãƒ©ãƒ¼å†…å®¹
```
AnotherOperationInProgress: Another operation on this or dependent resource is in progress. To retrieve status of the operation use uri: https://management.azure.com/subscriptions/~~~~
```

# 2. è§£æ±ºç­–

### Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–
Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ä½œæ¥­ã®è² è·ã‚’è»½æ¸›ã—ã¾ã™ã€‚

### ç¹°ã‚Šè¿”ã—åˆ†ã‚’ä½¿ã£ã¦è¤‡æ•°ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆ
ç¹°ã‚Šè¿”ã—åˆ†ã‚’ä½¿ã£ã¦è¤‡æ•°ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆã™ã‚Œã°ã€è¦ä»¶â‘¡ã®ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã§ãã¾ã—ãŸã€‚

# 3. ãƒãƒ³ã‚ºã‚ªãƒ³

ãã‚Œã§ã¯å®Ÿéš›ã«ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

### 3-1.Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
æ—©é€Ÿã§ã™ãŒã€Bicepã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
PCä¸Šã®ä»»æ„ã®å ´æ‰€ã«Bicepãƒãƒ³ã‚ºã‚ªãƒ³ã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3585159/36643024-e3e1-5605-a25d-62de9f09bc69.png)
<br>
VSCodeã‚’èµ·å‹•ã—ã€å…ˆã»ã©ä½œæˆã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãã¾ã™ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3585159/ed5b7a0f-ab2d-fae6-a25f-4b374b978c79.png)
<br>
ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ã‚¯ã‚’æŠ¼ã—ã¦ã€main.bicepã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3585159/bed6656c-b2f0-2a9a-2ae5-e6abb2573080.png)
<br>
main.bicepã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
paramãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰å†…ã§ä½¿ç”¨ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚
ã“ã®ã‚³ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ³ãƒˆã¯ã‚µãƒ–ãƒãƒƒãƒˆã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ã‚’é…åˆ—ã§å®šç¾©ã—ã¦ã„ã‚‹ã¨ã“ã‚ã§ã™ã€‚
```
// å¤‰æ•°ã®å®šç¾©
@description('ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åå‰')
param vnetName string = 'testVnet'

@description('ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹')
param vnetAddressPrefix string = '10.0.0.0/16'

@description('ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚µãƒ–ãƒãƒƒãƒˆ')
param Subnets array = [
  {
    // GatewaySubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'GatewaySubnet'
    subnetPrefix: '10.0.1.0/24'
  }
  {
    // FWSubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'AzureFirewallSubnet'
    subnetPrefix: '10.0.2.0/24'
  }
  {
    // PrivateSubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'PrivateSubnet'
    subnetPrefix: '10.0.3.0/24'
  }
  {
    // ProtectedSubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'ProtectedSubnet'
    subnetPrefix: '10.0.4.0/24'
  }
]

@description('FWSubnetã®Azure Firewallã®IPã‚¢ãƒ‰ãƒ¬ã‚¹')
param SpokeFWIP string = '10.0.2.4'
```
<br>

æ¬¡ã«ã€ãã®ä¸‹ã«ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ•°ã«ä»£å…¥ã—ã¾ã™ã€‚
```
// ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’JapanEastã«æŒ‡å®š
var location = 'JapanEast'
```
<br>

æ¬¡ã«ã€ãã®ä¸‹ã«ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆã—ã€ã•ãã»ã©å®šç¾©ã—ãŸã‚µãƒ–ãƒãƒƒãƒˆã®é…åˆ—åˆ†ã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’ç¹°ã‚Šè¿”ã—(foræ–‡)ã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚
```
// ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã‚µãƒ–ãƒãƒƒãƒˆã®ä½œæˆ
resource virtualNetwork 'Microsoft.Network/virtualNetworks@2023-11-01' = {
  name: vnetName
  location: location
  properties: {
    addressSpace: {
      addressPrefixes: [ vnetAddressPrefix ]
    }
    // ç¹°ã‚Šè¿”ã—ã§ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆ
    subnets: [for subnet in Subnets: {
      name: subnet.name
      properties: {
        addressPrefix: subnet.subnetPrefix
      }
    }]
  }
}
```
<br>

æ¬¡ã«ã€ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚
ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸‹ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
ä»Šå›ã¯GWã‚µãƒ–ãƒãƒƒãƒˆä»¥å¤–ã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯çœç•¥ã—ã¾ã™ã€‚
```
// GWã‚µãƒ–ãƒãƒƒãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
resource routeTable1 'Microsoft.Network/routeTables@2023-11-01' = {
  name: 'GW-rt'
  location: location
  properties: {
    routes: [
      {
        name: 'ToFW'
        properties: {
          addressPrefix: Subnets[2].subnetPrefix // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: SpokeFWIP
        }
      }
    ]
  }
  dependsOn: [
    virtualNetwork
  ]
}
```
<br>

æ¬¡ã«ã€NSGã‚’å®šç¾©ã—ã¾ã™ã€‚
ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸‹ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
ä»Šå›ã¯ãƒ—ãƒ­ãƒ†ã‚¯ãƒ†ãƒƒãƒ‰ã‚µãƒ–ãƒãƒƒãƒˆä»¥å¤–ã®NSGã¯çœç•¥ã—ã¾ã™ã€‚
```
// Protectedã‚µãƒ–ãƒãƒƒãƒˆã®NSGã®ä½œæˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦å‰‡ã®è¨­å®š
resource protectedNsg 'Microsoft.Network/networkSecurityGroups@2023-11-01' = {
  name: 'protected-nsg'
  location: location
  properties: {
    securityRules: [
      {
        name: 'DenyAllInbound'
        properties: {
          priority: 1000
          direction: 'Inbound'
          access: 'Deny'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: '0.0.0.0/0'
          destinationAddressPrefix: '*'
        }
      }
      {
        name: 'DenyAlloutbound'
        properties: {
          priority: 1010
          direction: 'Outbound'
          access: 'Deny'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: '*'
          destinationAddressPrefix: '0.0.0.0/0'
        }
      }
      {
        name: 'AllowFromPrivateSubnet'
        properties: {
          priority: 900
          direction: 'Inbound'
          access: 'Allow'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: Subnets[2].subnetPrefix
          destinationAddressPrefix: '*'
        }
      }
      {
        name: 'AllowToPrivateSubnet'
        properties: {
          priority: 990
          direction: 'Outbound'
          access: 'Allow'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: '*'
          destinationAddressPrefix: Subnets[2].subnetPrefix
        }
      }
    ]
  }
}
```
<br>

æœ€å¾Œã«ã€ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¨NSGã‚’ãã‚Œãã‚Œã‚µãƒ–ãƒãƒƒãƒˆã«ç´ã¥ã‘ã¾ã™ã€‚
ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚
```
// GWã‚µãƒ–ãƒãƒƒãƒˆã¸ã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ç´ã¥ã‘
resource GatewaySubnet 'Microsoft.Network/virtualNetworks/subnets@2023-11-01' = {
  parent: virtualNetwork
  name: 'GatewaySubnet'
  properties: {
    addressPrefix: Subnets[0].subnetPrefix
    routeTable: {
      id: routeTable1.id
    }
  }
  dependsOn: [
    virtualNetwork
    routeTable1
  ]
}

// Protectedã‚µãƒ–ãƒãƒƒãƒˆã¸ã®NSGç´ã¥ã‘
resource protectedSubnet 'Microsoft.Network/virtualNetworks/subnets@2023-11-01' = {
  parent: virtualNetwork
  name: 'ProtectedSubnet'
  properties: {
    addressPrefix: Subnets[3].subnetPrefix
    networkSecurityGroup: {
      id: protectedNsg.id
    }
  }
  dependsOn: [
    virtualNetwork
    protectedNsg
  ]
}
```

ä»¥ä¸Šã§ã€Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆã¯å®Œäº†ã§ã™ï¼
ä»¥ä¸‹ãŒå®Œæˆã—ãŸã‚³ãƒ¼ãƒ‰å…¨ä½“ã«ãªã‚Šã¾ã™ã€‚

### main.bicep
```
// å¤‰æ•°ã®å®šç¾©
@description('ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åå‰')
param vnetName string = 'testVnet'

@description('ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹')
param vnetAddressPrefix string = '10.0.0.0/16'

@description('ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚µãƒ–ãƒãƒƒãƒˆ')
param Subnets array = [
  {
    // GatewaySubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'GatewaySubnet'
    subnetPrefix: '10.0.1.0/24'
  }
  {
    // FWSubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'AzureFirewallSubnet'
    subnetPrefix: '10.0.2.0/24'
  }
  {
    // PrivateSubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'PrivateSubnet'
    subnetPrefix: '10.0.3.0/24'
  }
  {
    // ProtectedSubnetã®åå‰ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²
    name: 'ProtectedSubnet'
    subnetPrefix: '10.0.4.0/24'
  }
]

@description('FWSubnetã®Azure Firewallã®IPã‚¢ãƒ‰ãƒ¬ã‚¹')
param SpokeFWIP string = '10.0.2.4'

// ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’JapanEastã«æŒ‡å®š
var location = 'JapanEast'

// ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã‚µãƒ–ãƒãƒƒãƒˆã®ä½œæˆ
resource virtualNetwork 'Microsoft.Network/virtualNetworks@2023-11-01' = {
  name: vnetName
  location: location
  properties: {
    addressSpace: {
      addressPrefixes: [ vnetAddressPrefix ]
    }
    // ç¹°ã‚Šè¿”ã—ã§ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆ
    subnets: [for subnet in Subnets: {
      name: subnet.name
      properties: {
        addressPrefix: subnet.subnetPrefix
      }
    }]
  }
}

// GWã‚µãƒ–ãƒãƒƒãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
resource routeTable1 'Microsoft.Network/routeTables@2023-11-01' = {
  name: 'GW-rt'
  location: location
  properties: {
    routes: [
      {
        name: 'ToFW'
        properties: {
          addressPrefix: Subnets[2].subnetPrefix // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ
          nextHopType: 'VirtualAppliance'
          nextHopIpAddress: SpokeFWIP
        }
      }
    ]
  }
  dependsOn: [
    virtualNetwork
  ]
}

// Protectedã‚µãƒ–ãƒãƒƒãƒˆã®NSGã®ä½œæˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦å‰‡ã®è¨­å®š
resource protectedNsg 'Microsoft.Network/networkSecurityGroups@2023-11-01' = {
  name: 'protected-nsg'
  location: location
  properties: {
    securityRules: [
      {
        name: 'DenyAllInbound'
        properties: {
          priority: 1000
          direction: 'Inbound'
          access: 'Deny'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: '0.0.0.0/0'
          destinationAddressPrefix: '*'
        }
      }
      {
        name: 'DenyAlloutbound'
        properties: {
          priority: 1010
          direction: 'Outbound'
          access: 'Deny'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: '*'
          destinationAddressPrefix: '0.0.0.0/0'
        }
      }
      {
        name: 'AllowFromPrivateSubnet'
        properties: {
          priority: 900
          direction: 'Inbound'
          access: 'Allow'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: Subnets[2].subnetPrefix
          destinationAddressPrefix: '*'
        }
      }
      {
        name: 'AllowToPrivateSubnet'
        properties: {
          priority: 990
          direction: 'Outbound'
          access: 'Allow'
          protocol: '*'
          sourcePortRange: '*'
          destinationPortRange: '*'
          sourceAddressPrefix: '*'
          destinationAddressPrefix: Subnets[2].subnetPrefix
        }
      }
    ]
  }
}

// GWã‚µãƒ–ãƒãƒƒãƒˆã¸ã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ç´ã¥ã‘
resource GatewaySubnet 'Microsoft.Network/virtualNetworks/subnets@2023-11-01' = {
  parent: virtualNetwork
  name: 'GatewaySubnet'
  properties: {
    addressPrefix: Subnets[0].subnetPrefix
    routeTable: {
      id: routeTable1.id
    }
  }
  dependsOn: [
    virtualNetwork
    routeTable1
  ]
}

// Protectedã‚µãƒ–ãƒãƒƒãƒˆã¸ã®NSGç´ã¥ã‘
resource protectedSubnet 'Microsoft.Network/virtualNetworks/subnets@2023-11-01' = {
  parent: virtualNetwork
  name: 'ProtectedSubnet'
  properties: {
    addressPrefix: Subnets[3].subnetPrefix
    networkSecurityGroup: {
      id: protectedNsg.id
    }
  }
  dependsOn: [
    virtualNetwork
    protectedNsg
  ]
}
```

### 3-2.Azureãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰Cloud Shellã‚’ä½¿ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤

Azureãƒãƒ¼ã‚¿ãƒ«å³ä¸Šã®[CloudShell]ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã€é–‹ãã¾ã™ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3585159/c95696d8-2945-1e81-5bcc-39030667240a.png)
<br>

[ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†]â†’[ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰]ã‹ã‚‰å…ˆã»ã©ä½œæˆã—ãŸmain.bicepã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¨ã€å·¦ä¸‹ã«ã€Œãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3585159/4c3dd017-d87e-bbf8-d1a9-471329184314.png)
<br>

CloudShellã§ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€"testRG"ã¨ã„ã†ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚
```
az group create --name testRG --location JapanEast
```
<br>

CloudShellã§ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—åã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åã‚’shellã®å¤‰æ•°ã«æ ¼ç´ã—ã¾ã™ã€‚
```
RESOURCE_GROUP='testRG'
VN_TEMPLATE_FILE='main.bicep'
```
<br>

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ã€‚
å®Œäº†ã¾ã§ãŠã‚ˆã1åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚
```
az deployment group create \
  --resource-group $RESOURCE_GROUP \
  --template-file $VN_TEMPLATE_FILE
```
<br>

ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Œã°ã€ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã§ã™ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3585159/f0f4ecfb-a387-5961-ec86-044e039c9110.png)

<br>

Azureãƒãƒ¼ã‚¿ãƒ«ä¸Šã§ã‚‚ã¡ã‚ƒã‚“ã¨ã‚µãƒ–ãƒãƒƒãƒˆãŒ4ã¤ã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3585159/3a7754e6-9bc0-89e6-ed65-40ef35ac3086.png)
<br>

ä»¥ä¸Šã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Œäº†ã§ã™ï¼

### 3-3.ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤

CloudShellã‚’é–‹ãã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ã“ã¡ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã§ä»Šå›ä½œæˆã—ãŸã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚
```
az group delete --name testRG --yes
```

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ã€Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦è¤‡æ•°ã‚µãƒ–ãƒãƒƒãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¨˜è¿°æ–¹æ³•ã¯è‰²ã€…ãªãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆã«å¿œç”¨ã§ãã‚‹ã®ã§ã€çš†ã•ã‚“ã‚‚ã©ã‚“ã©ã‚“è‡ªå‹•åŒ–ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¦ãã ã•ã„ï¼
